---
title: "Civility interannotator analysis"
date: "`r Sys.Date()`"
output: 
  html_notebook:
    code_folding: hide
    toc: yes
  md_document:
    variant: gfm 
    toc: yes
---

```{r setup}
source(here::here("src/common_basis.R"))
library(irr)
```

```{r}
annotation_set_l <- annotation_set %>% collect()
```


```{r}
civility_annotations_long <- read_csv(here("data/work/annotations/civility-marina.csv")) %>% 
  mutate(annotator="Marina") %>%
  union_all(
    read_csv(here("data/work/annotations/civility-kart.csv")) %>% 
    mutate(annotator="KÃ¤rt") 
  ) %>%
  union_all(
    read_csv(here("data/work/annotations/civility-nan.csv")) %>% 
    mutate(annotator="Nan") 
  ) %>%
  pivot_longer(c(ap,dd,fm,gt,im,is,jc,mc,md,pd),names_to="measure") %>%
  mutate(value=as.integer(str_extract(value, "\\[\\{\"rating\":(\\d)\\}\\]", group=1))) %>%
  left_join(annotation_set_l %>% select(permalink,set))

civility_annotations_wide <- civility_annotations_long %>%
  pivot_wider(values_from=value, names_from=annotator)

```

```{r}
civility_annotations_long %>%
  ggplot(aes(x=measure,y=value,color=annotator)) +
  geom_jitter(size=0.5) +
  theme_hsci_discrete() +
  scale_y_continuous(breaks=0:10)
```

```{r}
civility_annotations_long %>%
  group_by(permalink,measure) %>%
  summarise(sd=sd(value)) %>%
  ggplot(aes(x=measure,y=sd)) +
  geom_quasirandom() +
  theme_hsci_discrete()
```

```{r}
civility_annotations_long %>%
  group_by(permalink,measure) %>%
  filter(any(value!=1)) %>%
  summarise(sd=sd(value)) %>%
  ggplot(aes(x=measure,y=sd)) +
  geom_quasirandom() +
  theme_hsci_discrete()
```
```{r}
civility_annotations_long %>%
  group_by(permalink,measure) %>%
  filter(any(value!=1)) %>%
  summarise(sd=sd(value)) %>%
  group_by(measure) %>%
  summarise(mean_sd=mean(sd,na.rm=T)) %>%
  ggplot(aes(x=measure,y=mean_sd)) +
  geom_col() +
  theme_hsci_discrete()
```

```{r}
civility_annotations_long %>%
  group_by(subreddit,measure) %>%
  mutate(n=n()) %>%
  ungroup() %>%
  mutate(subreddit=if_else(n>5,subreddit,"other")) %>%
  group_by(subreddit,measure) %>%
  summarise(mv=mean(value,na.rm=T),.groups="drop") %>%
  mutate(subreddit=fct_relevel(subreddit,"other", after=Inf)) %>%
  ggplot(aes(x=measure,y=mv,fill=subreddit)) +
  geom_col(position='dodge') +
  theme_hsci_discrete() +
  theme(legend.position="bottom")
```

```{r}
tibble(threshold=2:7) %>% 
  cross_join(civility_annotations_long) %>% 
  mutate(civil=value>=threshold) %>%
  group_by(set,permalink,threshold,measure) %>%
  summarise(civil=any(civil),.groups="drop") %>%
  count(threshold,set,measure,civil) %>%
  group_by(threshold,set,measure) %>%
  mutate(prop=n/sum(n)) %>%
  filter(civil) %>%
  ggplot(aes(x=measure,y=prop,fill=set)) +
  facet_wrap(~threshold) +
  geom_col(position='dodge') +
  theme_hsci_discrete() +
  theme(legend.position="bottom")
```

```{r}
civility_annotations_long %>% 
  mutate(civil=value>=4) %>%
  group_by(set,permalink,measure) %>%
  summarise(civil=any(civil),.groups="drop") %>%
  count(set,measure,civil) %>%
  group_by(set,measure) %>%
  mutate(prop=n/sum(n)) %>%
  ungroup() %>%
  filter(civil) %>%
  ggplot(aes(x=measure,y=prop,fill=set)) +
  geom_col(position='dodge') +
  theme_hsci_discrete() +
  theme(legend.position="bottom")
```

```{r}
civility_annotations_long %>% 
  filter(!measure %in% c("dd","is")) %>%
  mutate(civil=value>=4) %>%
  group_by(set,permalink,measure) %>%
  summarise(civil=any(civil),.groups="drop") %>%
  group_by(set,permalink) %>%
  summarise(civil=sum(civil)>=2,.groups="drop") %>%
  count(set,civil) %>%
  group_by(set) %>%
  mutate(prop=n/sum(n)) %>%
  filter(civil) %>%
  ggplot(aes(x=set,y=prop)) + 
  geom_col() +
  coord_flip() +
  theme_hsci_discrete()
```

```{r}
civility_annotations_long %>% 
  mutate(negative=measure %in% c("dd","is")) %>%
  mutate(civil=value>=4) %>%
  group_by(set,negative,permalink,measure) %>%
  summarise(civil=any(civil),.groups="drop") %>%
  group_by(set,permalink) %>%
  summarise(civil=sum(civil&!negative)-sum(civil&negative)>=1,.groups="drop") %>%
  count(set,civil) %>%
  group_by(set) %>%
  mutate(prop=n/sum(n)) %>%
  filter(civil) %>%
  ggplot(aes(x=set,y=prop)) + 
  geom_col() +
  coord_flip() +
  theme_hsci_discrete()
```

```{r}
civility_annotations_long %>% 
  filter(!measure %in% c("dd","is")) %>%
  mutate(civil=value>=4) %>%
  group_by(set,permalink,measure) %>%
  summarise(civil=any(civil),.groups="drop") %>%
  group_by(set,permalink) %>%
  summarise(civil=sum(civil)>=2,.groups="drop") %>%
  filter(civil,set!="data_driven_civil_discourse_subset")
```

```{r}
civility_annotations_long %>% 
  mutate(negative=measure %in% c("dd","is")) %>%
  mutate(civil=value>=4) %>%
  group_by(set,negative,permalink,measure) %>%
  summarise(civil=any(civil),.groups="drop") %>%
  group_by(set,permalink) %>%
  summarise(civil=sum(civil&!negative,na.rm=T)-sum(civil&negative,na.rm=T)>=1,.groups="drop") %>%
  filter(civil)
```

